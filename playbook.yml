- name: Configure App Server
  hosts: servers
  become: yes

  vars_files:
    - vars/secrets.yml

  tasks:
    # --- SWAP CONFIGURATION ---
    - name: Check if swap file exists
      stat:
        path: /swapfile
      register: swap_file_check

    - name: Create 2GB swap file
      command: fallocate -l 2G /swapfile
      when: not swap_file_check.stat.exists

    - name: Set swap file permissions
      file:
        path: /swapfile
        owner: root
        group: root
        mode: "0600"

    - name: Make swap file
      command: mkswap /swapfile
      when: not swap_file_check.stat.exists

    - name: Enable swap
      command: swapon /swapfile
      when: not swap_file_check.stat.exists

    - name: Add swap to fstab
      mount:
        name: none
        src: /swapfile
        fstype: swap
        opts: sw
        state: present

    # --- SYSTEMD DNS CONFIGURATION (Required for WireGuard) ---
    - name: Disable systemd-resolved StubListener
      lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: "^#?DNSStubListener="
        line: "DNSStubListener=no"
        state: present

    - name: Update resolv.conf symlink to use upstream DNS directly
      file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        state: link
        force: yes

    # [FIX] Restart immediately and unconditionally to ensure Port 53 is freed.
    # We do this as a Task, not a Handler, to fix the idempotency issue.
    - name: Apply systemd-resolved changes immediately
      service:
        name: systemd-resolved
        state: restarted

    # --- PACKAGES & DOCKER ---
    - name: Add Google Cloud Ops Agent repo
      shell: |
        curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
        bash add-google-cloud-ops-agent-repo.sh --also-install
      args:
        creates: /etc/apt/sources.list.d/google-cloud-ops-agent.list

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Install sslh
      apt:
        name: sslh
        state: present

    # --- SSLH (BUILD FROM SOURCE FOR UDP SUPPORT) ---
    - name: Remove apt sslh package (too old)
      apt:
        name: sslh
        state: absent
        purge: yes

    - name: Install sslh build dependencies
      apt:
        name:
          - git
          - make
          - gcc
          - autoconf # Required to generate configure script
          - automake # Required for build system
          - libtool # Often required for autoreconf
          - pkg-config # Helper for finding libraries
          - libconfig-dev
          - libpcre2-dev
          - libev-dev
          - libcap-dev # Required for transparent proxying
          - libsystemd-dev # CRITICAL: Required for systemd socket activation support
          - libbsd-dev # Required for process name updates (ps output)
          - libwrap0-dev # TCP wrappers support
        state: present

    - name: Checkout sslh source code
      git:
        repo: https://github.com/yrutschle/sslh.git
        dest: /opt/sslh-source
        version: v2.3.0 # Use latest stable version (supports UDP & autoconf)
        force: yes # Ensure we cleanly switch versions if repo exists

    - name: Generate configure script (autoreconf)
      command: autoreconf --install
      args:
        chdir: /opt/sslh-source
        creates: /opt/sslh-source/configure

    - name: Configure build
      command: ./configure
      args:
        chdir: /opt/sslh-source
        creates: /opt/sslh-source/Makefile

    - name: Compile sslh
      command: make
      args:
        chdir: /opt/sslh-source
        creates: /opt/sslh-source/sslh-select

    - name: Install sslh binary
      copy:
        src: /opt/sslh-source/sslh-select
        dest: /usr/local/sbin/sslh
        mode: "0755"
        remote_src: yes
      notify: restart sslh

    - name: Create sslh user
      user:
        name: sslh
        system: yes
        shell: /usr/sbin/nologin

    # --- SSLH CONFIGURATION ---
    - name: Configure sslh for UDP multiplexing (WireGuard/DNS)
      copy:
        dest: /etc/sslh.cfg
        content: |
          verbose: false;
          foreground: true;
          inetd: false;
          numeric: true;
          transparent: false;
          timeout: 2;
          user: "sslh";
          pidfile: "/var/run/sslh.pid";

          # Define protocols
          protocols:
          (
              # WireGuard (UDP) - Matches handshake (0x01) or data (0x04)
              { name: "wireguard"; host: "localhost"; port: "51820"; is_udp: true; regex: "^\x01\x00\x00\x00"; },
              { name: "wireguard"; host: "localhost"; port: "51820"; is_udp: true; regex: "^\x04\x00\x00\x00"; },
              
              # Iodine (Default UDP fallback)
              { name: "anyprot"; host: "localhost"; port: "5353"; is_udp: true; }
          );
      notify: restart sslh

    - name: Create systemd service for sslh
      copy:
        dest: /etc/systemd/system/sslh.service
        content: |
          [Unit]
          Description=SSL/SSH multiplexer (Custom Build)
          After=network.target

          [Service]
          # Use -p for port (v2.x syntax) and ensure --udp is passed
          ExecStart=/usr/local/sbin/sslh --foreground --user sslh -p 0.0.0.0:53 --udp --config /etc/sslh.cfg
          KillMode=process
          Restart=always

          [Install]
          WantedBy=multi-user.target
      notify: restart sslh

    - name: Ensure sslh is enabled and running
      service:
        name: sslh
        state: started
        enabled: yes

    # --- SSLH CONFIGURATION ---
    - name: Configure sslh for UDP multiplexing (WireGuard/DNS)
      copy:
        dest: /etc/sslh.cfg
        content: |
          # General settings
          verbose: false;
          foreground: true;
          inetd: false;
          numeric: true;
          transparent: false;
          timeout: 2;
          user: "sslh";  # Drop privileges to this user after binding ports
          pidfile: "/var/run/sslh.pid";

          # LISTENING SOCKETS (The critical fix)
          listen:
          (
              { host: "0.0.0.0"; port: "53"; is_udp: true; }
          );

          # TARGET PROTOCOLS
          protocols:
          (
              # WireGuard (UDP) - Handshake (0x01) and Data (0x04)
              { name: "wireguard"; host: "localhost"; port: "51820"; is_udp: true; regex: "^\x01\x00\x00\x00"; },
              { name: "wireguard"; host: "localhost"; port: "51820"; is_udp: true; regex: "^\x04\x00\x00\x00"; },
              
              # Iodine (Default UDP fallback)
              { name: "anyprot"; host: "localhost"; port: "5353"; is_udp: true; }
          );
      notify: restart sslh

    - name: Create systemd service for sslh
      copy:
        dest: /etc/systemd/system/sslh.service
        content: |
          [Unit]
          Description=SSL/SSH multiplexer (Custom Build)
          After=network.target

          [Service]
          # CLEAN COMMAND: All settings are now in the config file
          ExecStart=/usr/local/sbin/sslh --foreground --config /etc/sslh.cfg
          KillMode=process
          Restart=always

          # Ensure it can read the config and bind ports before dropping user
          User=root

          [Install]
          WantedBy=multi-user.target
      notify: restart sslh

    # Reset systemd to handle the changed unit file and ensure clean start
    - name: Reset systemd state for sslh
      systemd:
        name: sslh
        daemon_reload: yes
        masked: no
        enabled: yes

    - name: Ensure sslh is enabled and running
      service:
        name: sslh
        state: started
        enabled: yes

    # --- DOCKER SETUP ---
    - name: Create directory for apt keyrings
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker GPG key
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"
        force: yes

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ ansible_facts['distribution_release'] }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Add dev user to the docker group
      user:
        name: dev
        groups: docker
        append: yes

    - name: Create base directories
      file:
        path: "/opt/docker/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - services
        - caddy
        - wireguard

    # Enable IPv4 forwarding on the HOST OS (Critical for VPN routing)
    - name: Enable Host IP Forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
        reload: yes

    # Configure NAT for Iodine Tunnel
    # This ensures traffic from the tunnel (10.0.0.0/8) is masqueraded
    # as the server's public IP when leaving via the default interface.
    - name: Enable Masquerade for Iodine Tunnel
      iptables:
        table: nat
        chain: POSTROUTING
        source: 10.0.0.0/8
        out_interface: "{{ ansible_default_ipv4.interface }}"
        jump: MASQUERADE
        comment: "Allow Iodine tunnel traffic to reach the internet"

    # --- CONFIG FILES ---
    - name: Configure Google Cloud Ops Agent
      template:
        src: templates/ops-agent-config.yaml.j2
        dest: /etc/google-cloud-ops-agent/config.yaml
        mode: "0644"
      notify: Restart Ops Agent

    - name: Copy Caddyfile to server
      template:
        src: templates/Caddyfile.j2
        dest: /opt/docker/caddy/Caddyfile
      notify: Restart Caddy

    - name: Copy main Docker Compose file to server
      template:
        src: templates/docker-compose.yml.j2
        dest: /opt/docker/compose.yml

    - name: Copy WireGuard Compose file
      template:
        src: templates/wireguard.yml.j2
        dest: /opt/docker/services/wireguard.yml
        mode: "0644"

    # --- CI/CD APP DEPLOYMENT STEPS ---

    - name: Move application compose file into place
      copy:
        src: "/home/dev/{{ app_name }}.yml"
        dest: "/opt/docker/services/{{ app_name }}.yml"
        owner: root
        group: root
        mode: "0644"
        remote_src: yes
      when: app_name is defined

    - name: Configure Docker to use Google Cloud credentials
      command: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

    - name: Find all individual service compose files
      find:
        paths: /opt/docker/services
        patterns: "*.yml"
      register: service_files

    # THIS IS THE CRITICAL RESTORED TASK
    - name: Stop old application instance to free memory
      community.docker.docker_compose_v2:
        project_src: /opt/docker
        files: "{{ ['compose.yml'] + (service_files.files | map(attribute='path') | list) }}"
        services:
          - "{{ app_name }}-app"
        state: absent
      # Only run this if we are actually deploying an app
      when: app_name is defined

    # --- FINAL CONVERGENCE ---

    - name: Run all services with Docker Compose
      community.docker.docker_compose_v2:
        project_src: /opt/docker
        files: "{{ ['compose.yml'] + (service_files.files | map(attribute='path') | list) }}"
        state: present
        remove_orphans: yes

    - name: Prune unused Docker images
      community.docker.docker_prune:
        images: yes
        images_filters:
          dangling: false
      ignore_errors: yes

    - name: Prune unused Docker volumes
      community.docker.docker_prune:
        volumes: yes
      ignore_errors: yes

  handlers:
    - name: Restart Ops Agent
      service:
        name: google-cloud-ops-agent
        state: restarted

    - name: restart sslh
      service:
        name: sslh
        state: restarted
        enabled: yes

    - name: Restart systemd-resolved
      service:
        name: systemd-resolved
        state: restarted

    - name: Restart Caddy
      community.docker.docker_compose_v2:
        project_src: /opt/docker
        services:
          - caddy
        state: restarted
