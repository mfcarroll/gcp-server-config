- name: Configure App Server
  hosts: servers
  become: yes

  vars_files:
    - vars/secrets.yml

  tasks:
    # --- SWAP CONFIGURATION ---
    - name: Check if swap file exists
      stat:
        path: /swapfile
      register: swap_file_check

    - name: Create 2GB swap file
      command: fallocate -l 2G /swapfile
      when: not swap_file_check.stat.exists

    - name: Set swap file permissions
      file:
        path: /swapfile
        owner: root
        group: root
        mode: "0600"

    - name: Make swap file
      command: mkswap /swapfile
      when: not swap_file_check.stat.exists

    - name: Enable swap
      command: swapon /swapfile
      when: not swap_file_check.stat.exists

    - name: Add swap to fstab
      mount:
        name: none
        src: /swapfile
        fstype: swap
        opts: sw
        state: present

    # --- SYSTEMD DNS CONFIGURATION (Required for WireGuard) ---
    - name: Disable systemd-resolved StubListener
      lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: "^#?DNSStubListener="
        line: "DNSStubListener=no"
        state: present

    - name: Update resolv.conf symlink to use upstream DNS directly
      file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        state: link
        force: yes

    # [FIX] Restart immediately and unconditionally to ensure Port 53 is freed.
    # We do this as a Task, not a Handler, to fix the idempotency issue.
    - name: Apply systemd-resolved changes immediately
      service:
        name: systemd-resolved
        state: restarted

    # --- PACKAGES & DOCKER ---
    - name: Add Google Cloud Ops Agent repo
      shell: |
        curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
        bash add-google-cloud-ops-agent-repo.sh --also-install
      args:
        creates: /etc/apt/sources.list.d/google-cloud-ops-agent.list

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - software-properties-common
          - python3-pip
          - google-cloud-sdk
        state: present

    - name: Add Docker GPG key
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"
        force: yes

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ ansible_facts['distribution_release'] }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Add dev user to the docker group
      user:
        name: dev
        groups: docker
        append: yes

    - name: Create base directories
      file:
        path: "/opt/docker/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - services
        - caddy
        - wireguard

    # [NEW] Enable IPv4 forwarding on the HOST OS (Critical for VPN routing)
    - name: Enable Host IP Forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
        reload: yes

    # --- CONFIG FILES ---
    - name: Configure Google Cloud Ops Agent
      template:
        src: templates/ops-agent-config.yaml.j2
        dest: /etc/google-cloud-ops-agent/config.yaml
        mode: "0644"
      notify: Restart Ops Agent

    - name: Copy Caddyfile to server
      template:
        src: templates/Caddyfile.j2
        dest: /opt/docker/caddy/Caddyfile
      notify: Restart Caddy

    - name: Copy main Docker Compose file to server
      template:
        src: templates/docker-compose.yml.j2
        dest: /opt/docker/compose.yml

    - name: Copy WireGuard Compose file
      template:
        src: templates/wireguard.yml.j2
        dest: /opt/docker/services/wireguard.yml
        mode: "0644"

    # --- CI/CD APP DEPLOYMENT STEPS ---

    - name: Move application compose file into place
      copy:
        src: "/home/dev/{{ app_name }}.yml"
        dest: "/opt/docker/services/{{ app_name }}.yml"
        owner: root
        group: root
        mode: "0644"
        remote_src: yes
      when: app_name is defined

    - name: Configure Docker to use Google Cloud credentials
      command: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

    - name: Find all individual service compose files
      find:
        paths: /opt/docker/services
        patterns: "*.yml"
      register: service_files

    # THIS IS THE CRITICAL RESTORED TASK
    - name: Stop old application instance to free memory
      community.docker.docker_compose_v2:
        project_src: /opt/docker
        files: "{{ ['compose.yml'] + (service_files.files | map(attribute='path') | list) }}"
        services:
          - "{{ app_name }}-app"
        state: absent
      # Only run this if we are actually deploying an app
      when: app_name is defined

    # --- FINAL CONVERGENCE ---

    - name: Run all services with Docker Compose
      community.docker.docker_compose_v2:
        project_src: /opt/docker
        files: "{{ ['compose.yml'] + (service_files.files | map(attribute='path') | list) }}"
        state: present
        remove_orphans: yes

    - name: Prune unused Docker images
      community.docker.docker_prune:
        images: yes
        images_filters:
          dangling: false
      ignore_errors: yes

    - name: Prune unused Docker volumes
      community.docker.docker_prune:
        volumes: yes
      ignore_errors: yes

  handlers:
    - name: Restart Ops Agent
      service:
        name: google-cloud-ops-agent
        state: restarted

    - name: Restart systemd-resolved
      service:
        name: systemd-resolved
        state: restarted

    - name: Restart Caddy
      community.docker.docker_compose_v2:
        project_src: /opt/docker
        services:
          - caddy
        state: restarted
